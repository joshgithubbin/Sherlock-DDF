name: Sync Wiki

on:
  push:
    paths:
      - 'Catalogue Plotting/Code/wikipages/**'
    branches:
      - main
  workflow_dispatch: 
jobs:
  sync-wiki:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout source repo
        uses: actions/checkout@v3

      - name: Clone wiki repo
        run: |
          git clone "https://x-access-token:${{ secrets.PERSONAL_TOKEN }}@github.com/${{ github.repository_owner }}/$(basename ${{ github.repository }}).wiki.git" wiki

      - name: Copy markdown files
        run: |
          rm -rf wiki/*
          cp -r "Catalogue Plotting/Code/wikipages/." wiki/

      - name: Rename markdown files based on Summary content
        run: |
          # Loop through all markdown files in the wiki directory
          for file in wiki/*.md; do
            # Find the line starting with '## Summary:' and extract everything after it
            summary=$(grep -m 1 '^## Summary:' "$file" | sed 's/^## Summary: //')
      
            # Check if the summary line is non-empty
            if [ -n "$summary" ]; then
              # Sanitize the summary to use it as a filename:
              # - Remove slashes and any other problematic characters
              # - Do not replace spaces, only remove characters that could cause issues
              new_name=$(echo "$summary" | tr -d '/\\')
      
              # Remove leading and trailing spaces from the new filename
              new_name=$(echo "$new_name" | sed 's/^[[:space:]]*//;s/[[:space:]]*$//')
      
              # Check if the new filename is non-empty, then rename the file
              if [ -n "$new_name" ]; then
                mv "$file" "wiki/${new_name}.md"
              fi
            fi
          done


      - name: Push to wiki
        run: |
          cd wiki
          git config user.name "${{ github.actor }}"
          git config user.email "${{ github.actor }}@users.noreply.github.com"
          git add .
          git commit -m "Update wiki pages" || echo "No changes to commit"
          git push
